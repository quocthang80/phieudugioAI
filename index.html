<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- ĐÃ CẬP NHẬT TIÊU ĐỀ -->
    <title>Ứng dụng Tạo Phiếu Đánh Giá Bài Dạy (Mẫu 5512)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Times New Roman', Times, serif; /* Changed font for official document look */
        }

        .app-container {
             font-family: 'Inter', sans-serif; /* Keep modern font for UI */
        }

        .ai-button {
            transition: all 0.2s ease-in-out;
        }

        .ai-button:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
        }

        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        
        /* Smaller loader for inline buttons */
        .loader.inline-loader {
            width: 16px;
            height: 16px;
            border-width: 2px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
        
        table, th, td {
            border: 1px solid #e5e7eb;
        }
    </style>
</head>

<body class="bg-gray-100 text-gray-800 p-4 sm:p-6 md:p-8">

    <div class="max-w-6xl mx-auto bg-white rounded-2xl shadow-lg p-6 sm:p-8 app-container">
        <div class="text-center mb-8">
            <!-- ĐÃ CẬP NHẬT TIÊU ĐỀ -->
            <h1 class="text-3xl sm:text-4xl font-bold text-blue-600">Phiếu Đánh Giá Bài Dạy (Mẫu CV 5512)</h1>
            <p class="text-gray-500 mt-2">Tạo và xuất phiếu đánh giá theo mẫu chuẩn của Bộ GD&ĐT</p>
        </div>

        <!-- Thông tin chung -->
        <div class="border-b pb-8 mb-8">
            <!-- ĐÃ CẬP NHẬT TIÊU ĐỀ -->
            <h2 class="text-2xl font-bold mb-4 text-gray-700">I. Thông tin chung</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label for="governing-body" class="block text-sm font-medium text-gray-700 mb-1">Cơ quan chủ quản (VD: UBND HUYỆN THẠNH TRỊ)</label>
                    <input type="text" id="governing-body" value="UBND HUYỆN THẠNH TRỊ" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="school-unit" class="block text-sm font-medium text-gray-700 mb-1">Đơn vị (VD: TRƯỜNG THCS PHÚ LỘC 2)</label>
                    <input type="text" id="school-unit" value="TRƯỜNG THCS PHÚ LỘC 2" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="teacherName" class="block text-sm font-medium text-gray-700 mb-1">Họ và tên giáo viên thực hiện</label>
                    <input type="text" id="teacherName" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                </div>
                 <div>
                    <label for="lessonName" class="block text-sm font-medium text-gray-700 mb-1">Tên bài dạy (chủ đề)</label>
                    <input type="text" id="lessonName" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="subject" class="block text-sm font-medium text-gray-700 mb-1">Môn học/Hoạt động giáo dục</label>
                    <input type="text" id="subject" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="className" class="block text-sm font-medium text-gray-700 mb-1">Lớp</label>
                    <input type="text" id="className" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="lesson-period" class="block text-sm font-medium text-gray-700 mb-1">Tiết (theo PPCT)</label>
                    <input type="text" id="lesson-period" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                </div>
                 <div>
                    <label for="lesson-date" class="block text-sm font-medium text-gray-700 mb-1">Ngày dạy</label>
                    <input type="date" id="lesson-date" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="attendee-name" class="block text-sm font-medium text-gray-700 mb-1">Họ và tên người dự (Người đánh giá)</label>
                    <input type="text" id="attendee-name" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="attendee-unit" class="block text-sm font-medium text-gray-700 mb-1">Đơn vị công tác người dự</label>
                    <input type="text" id="attendee-unit" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                </div>
            </div>
        </div>
        
        <!-- NEW FEATURE: PowerPoint Analysis -->
        <div class="border-b pb-8 mb-8">
            <h2 class="text-2xl font-bold mb-4 text-gray-700">Hỗ trợ từ AI với tệp PowerPoint</h2>
            <div class="bg-blue-50 p-6 rounded-lg">
                <p class="text-sm text-gray-600 mb-4">Tải lên tệp bài giảng (.pptx) để AI trích xuất nội dung, sau đó bạn có thể dùng AI để điền tự động vào các hoạt động hoặc nhận xét tổng quan.</p>
                <div class="flex items-center gap-4 mb-4">
                    <input type="file" id="ppt-upload" accept=".pptx" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-100 file:text-blue-700 hover:file:bg-blue-200"/>
                    <button id="extract-ppt-btn" class="flex-shrink-0 flex items-center gap-2 bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow-lg ai-button">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L11 5.414V13a1 1 0 11-2 0V5.414L7.707 6.707a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg>
                        Trích xuất nội dung
                    </button>
                </div>
                 <p id="ppt-status" class="text-sm text-center text-gray-600 h-5"></p>
                <div class="mt-4">
                    <button id="ai-overview-ppt-btn" class="flex items-center gap-2 bg-gradient-to-r from-teal-500 to-cyan-600 text-white font-semibold py-2 px-4 rounded-lg shadow-lg ai-button">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
                        </svg>
                        AI Nhận xét tổng quan bài giảng
                    </button>
                    <label for="ppt-analysis-result" class="block text-sm font-medium text-gray-700 mb-1 mt-4">Kết quả nhận xét tổng quan từ AI:</label>
                    <textarea id="ppt-analysis-result" rows="8" class="w-full p-3 border border-gray-300 rounded-md shadow-sm bg-gray-50" readonly placeholder="Kết quả nhận xét tổng quan của AI sẽ được hiển thị ở đây..."></textarea>
                </div>
            </div>
        </div>

        <!-- Hoạt động của giáo viên và học sinh -->
        <div class="mb-8">
            <!-- ĐÃ CẬP NHẬT TIÊU ĐỀ -->
            <h2 class="text-2xl font-bold mb-4 text-gray-700">Phần ghi nhận</h2>
            <div id="activities-container" class="space-y-6">
                <!-- Activity rows will be added here by JavaScript -->
            </div>
            <button id="add-activity-btn" class="mt-6 flex items-center gap-2 bg-blue-500 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-blue-600 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                Thêm hoạt động
            </button>
        </div>

        <!-- Bảng tiêu chí đánh giá -->
        <div class="mb-8">
            <!-- ĐÃ CẬP NHẬT TIÊU ĐỀ -->
            <h2 class="text-2xl font-bold mb-4 text-gray-700">II. Tiêu chí đánh giá</h2>
            <div class="overflow-x-auto">
                <table class="min-w-full bg-white rounded-lg">
                    <thead class="bg-gray-50">
                        <!-- Header will be generated by JS -->
                    </thead>
                    <tbody id="evaluation-table-body">
                        <!-- Evaluation criteria will be added here -->
                    </tbody>
                    <tfoot>
                        <tr class="bg-gray-100 font-semibold">
                            <!-- ĐÃ CẬP NHẬT COLSPAN -->
                            <td colspan="2" class="py-3 px-4 text-right">Tổng điểm:</td>
                            <td id="total-score" class="py-3 px-4 text-center text-lg">0.00/20.00</td>
                        </tr>
                        <tr class="bg-gray-100 font-semibold">
                            <td colspan="2" class="py-3 px-4 text-right">Xếp loại:</td>
                            <td id="rating" class="py-3 px-4 text-center text-lg">Không đạt</td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>

        <!-- Nhận xét chung và Góp ý -->
        <!-- ĐÃ THAY ĐỔI TOÀN BỘ PHẦN NÀY ĐỂ GIỐNG HỆT PDF -->
        <div class="mb-8">
            <h2 class="text-2xl font-bold mb-4 text-gray-700">III. Nhận xét, đánh giá</h2>
            <div class="space-y-6">
                <div>
                    <h3 class="text-lg font-semibold text-gray-800">1. Giáo viên dạy tự nhận xét</h3>
                    <div class="mt-2 space-y-3 pl-4">
                        <div>
                            <label for="gv-thanhcong" class="block text-sm font-medium text-gray-700 mb-1">a) Những thành công của giờ dạy (kế hoạch và tài liệu dạy học, tổ chức hoạt động học cho học sinh, hoạt động học của học sinh,...):</label>
                            <textarea id="gv-thanhcong" rows="3" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"></textarea>
                        </div>
                        <div>
                            <label for="gv-hanche" class="block text-sm font-medium text-gray-700 mb-1">b) Những hạn chế của tiết học cần lưu ý (kế hoạch và tài liệu dạy học, tổ chức hoạt động học cho học sinh, hoạt động học của học sinh,...):</label>
                            <textarea id="gv-hanche" rows="3" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"></textarea>
                        </div>
                    </div>
                </div>
                <div>
                    <!-- ĐÃ THÊM NÚT AI GỢI Ý VÀO KHU VỰC NÀY -->
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="text-lg font-semibold text-gray-800">2. Người dự giờ nhận xét</h3>
                        <button id="ai-attendee-review-btn" class="flex items-center gap-2 bg-gradient-to-r from-purple-500 to-indigo-600 text-white font-semibold py-2 px-3 rounded-lg shadow-md ai-button text-sm">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                            </svg>
                            AI Gợi ý Nhận xét
                        </button>
                    </div>
                    <div class="mt-2 space-y-3 pl-4">
                        <div>
                            <label for="nd-thanhcong" class="block text-sm font-medium text-gray-700 mb-1">a) Những thành công của giờ dạy (kế hoạch và tài liệu dạy học, tổ chức hoạt động học cho học sinh, hoạt động học của học sinh,...):</label>
                            <textarea id="nd-thanhcong" rows="3" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"></textarea>
                        </div>
                        <div>
                            <label for="nd-hanche" class="block text-sm font-medium text-gray-700 mb-1">b) Những hạn chế của tiết học cần lưu ý (kế hoạch và tài liệu dạy học, tổ chức hoạt động học cho học sinh, hoạt động học của học sinh,...):</label>
                            <textarea id="nd-hanche" rows="3" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"></textarea>
                        </div>
                    </div>
                </div>
            </div>
            <!-- ĐÃ XOÁ NÚT AI TỔNG HỢP CŨ -->
        </div>

        <!-- Chức năng -->
        <div class="text-center pt-8 border-t">
            <button id="export-docx-btn" class="bg-green-600 text-white font-bold py-3 px-6 rounded-lg shadow-xl hover:bg-green-700 transition-transform transform hover:scale-105">
                Xuất ra file DOCX
            </button>
        </div>
    </div>
    
    <!-- Libraries -->
    <script src="https://unpkg.com/docx@7.3.0/build/index.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <!-- Library for reading .pptx files -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>


    <script type="module">
        // --- Gemini API Call ---
        // Vui lòng thay thế 'YOUR_API_KEY' bằng API Key của bạn
        const GEMINI_API_KEY = 'AIzaSyDIpYsCuJg-cJci2Zh02GbaFg5TQGTT7Dc'; 
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${GEMINI_API_KEY}`;
        
        async function callGeminiApi(prompt) {
             if (GEMINI_API_KEY === 'YOUR_API_KEY') {
                 return "Lỗi: Vui lòng thay thế 'YOUR_API_KEY' trong mã nguồn bằng khóa API Gemini thực tế của bạn để sử dụng tính năng AI.";
             }
             console.log("Calling Gemini API...");
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                if (!response.ok) {
                    const errorBody = await response.json();
                    throw new Error(`API request failed: ${errorBody.error.message}`);
                }
                const data = await response.json();
                if (data.candidates?.[0]?.content?.parts?.[0]) {
                    return data.candidates[0].content.parts[0].text;
                }
                if (data.candidates?.[0]?.finishReason === 'SAFETY') {
                    return "Phản hồi từ AI đã bị chặn vì lý do an toàn.";
                }
                return "Không nhận được nội dung hợp lệ từ AI.";
            } catch (error) {
                console.error('Error calling Gemini API:', error);
                return `Lỗi kết nối với AI: ${error.message}.`;
            }
        }
        
        // --- Global State ---
        let activityCounter = 0;
        let pptTextContent = null;
        
        // --- DOM Elements ---
        const elements = {
            activitiesContainer: document.getElementById('activities-container'),
            addActivityBtn: document.getElementById('add-activity-btn'),
            evaluationTableBody: document.getElementById('evaluation-table-body'),
            totalScoreEl: document.getElementById('total-score'),
            ratingEl: document.getElementById('rating'),
            // ĐÃ XOÁ CÁC ELEMENT CỦA PHẦN D CŨ
            exportDocxBtn: document.getElementById('export-docx-btn'),
            
            // ĐÃ THÊM CÁC ELEMENT MỚI
            aiAttendeeReviewBtn: document.getElementById('ai-attendee-review-btn'),
            ndThanhCong: document.getElementById('nd-thanhcong'),
            ndHanche: document.getElementById('nd-hanche'),

            // PPT elements
            pptUpload: document.getElementById('ppt-upload'),
            extractPptBtn: document.getElementById('extract-ppt-btn'),
            aiOverviewPptBtn: document.getElementById('ai-overview-ppt-btn'),
            pptAnalysisResult: document.getElementById('ppt-analysis-result'),
            pptStatus: document.getElementById('ppt-status'),
        };
        
        // --- Data Structure for Evaluation ---
        // ĐÃ CẬP NHẬT THEO THANG 20 ĐIỂM (CV 5512)
        // ĐÃ LOẠI BỎ 'yeucau' VÌ KHÔNG CÓ TRONG BẢNG CỦA PDF
        const evaluationCriteria = [
            {
                category: "Kế hoạch bài dạy",
                items: [
                    { noidung: "1. Mức độ phù hợp của các hoạt động học với mục tiêu, nội dung và phương pháp dạy học được sử dụng.", diem_max: 1.0 },
                    { noidung: "2. Mức độ rõ ràng, chính xác của mục tiêu, nội dung, sản phẩm, cách thức tổ chức thực hiện mỗi hoạt động học của học sinh.", diem_max: 2.0 },
                    { noidung: "3. Mức độ phù hợp của thiết bị dạy học và học liệu được sử dụng để tổ chức các hoạt động học của học sinh.", diem_max: 1.0 },
                    { noidung: "4. Mức độ phù hợp của phương án kiểm tra, đánh giá trong quá trình tổ chức hoạt động học của học sinh.", diem_max: 2.0 }
                ]
            },
            {
                category: "Hoạt động của giáo viên",
                items: [
                    { noidung: "5. Mức độ chính xác, phù hợp, sinh động, hấp dẫn của nội dung, phương pháp và hình thức chuyển giao nhiệm vụ học tập cho học sinh.", diem_max: 2.0 },
                    { noidung: "6. Khả năng theo dõi, quan sát, phát hiện kịp thời những khó khăn của học sinh.", diem_max: 1.0 },
                    { noidung: "7. Mức độ phù hợp, hiệu quả của các biện pháp hỗ trợ và khuyến khích học sinh hợp tác, giúp đỡ nhau khi thực hiện nhiệm vụ học tập.", diem_max: 2.0 },
                    { noidung: "8. Mức độ chính xác, hiệu quả trong việc tổng hợp, phân tích, đánh giá quá trình và kết quả học tập của học sinh.", diem_max: 2.0 }
                ]
            },
            {
                category: "Hoạt động của học sinh",
                items: [
                    { noidung: "9. Khả năng tiếp nhận và sẵn sàng thực hiện nhiệm vụ học tập của tất cả học sinh trong lớp.", diem_max: 2.0 },
                    { noidung: "10. Mức độ tích cực, chủ động, sáng tạo, hợp tác của học sinh trong việc thực hiện các nhiệm vụ học tập.", diem_max: 2.0 },
                    { noidung: "11. Mức độ tham gia tích cực của học sinh trong trình bày, trao đổi, thảo luận về kết quả thực hiện nhiệm vụ học tập.", diem_max: 2.0 },
                    { noidung: "12. Mức độ đúng đắn, chính xác, phù hợp của các kết quả thực hiện nhiệm vụ học tập của học sinh.", diem_max: 1.0 }
                ]
            }
        ];
        
        // --- Functions ---
        
        function addActivityRow() {
            activityCounter++;
            const activityHtml = `
                <div class="activity-row border rounded-lg p-4 bg-gray-50/50" data-id="${activityCounter}">
                    <div class="flex justify-between items-center mb-3">
                        <input type="text" class="activity-title text-lg font-bold text-gray-800 bg-transparent w-full" value="Hoạt động ${activityCounter}: ">
                        <button class="remove-activity-btn text-red-500 hover:text-red-700 font-bold">&times; Xóa</button>
                    </div>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Hoạt động của Thầy và Trò</label>
                            <textarea rows="4" class="teacher-student-activity w-full p-2 border border-gray-300 rounded-md shadow-sm"></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Nội dung</label>
                            <textarea rows="3" class="content w-full p-2 border border-gray-300 rounded-md shadow-sm"></textarea>
                        </div>
                        <div>
                             <label class="block text-sm font-medium text-gray-700 mb-1">Nhận xét</label>
                            <textarea rows="3" class="review w-full p-2 border border-gray-300 rounded-md shadow-sm bg-white"></textarea>
                        </div>
                         <div class="flex justify-end items-center gap-4">
                              <button class="ai-fill-from-ppt-btn flex items-center gap-2 bg-gradient-to-r from-green-500 to-emerald-400 text-white font-semibold py-2 px-3 rounded-lg shadow-md ai-button">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M11.94 1.94a1 1 0 00-1.414 0l-8 8a1 1 0 000 1.414l8 8a1 1 0 001.414-1.414L4.828 11H18a1 1 0 100-2H4.828l7.11-7.11a1 1 0 00.002-1.414z" /></svg>
                                AI Điền nội dung từ PPT
                            </button>
                             <button class="ai-suggest-btn flex items-center gap-2 bg-gradient-to-r from-blue-500 to-teal-400 text-white font-semibold py-2 px-3 rounded-lg shadow-md ai-button">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" /></svg>
                                AI Gợi ý Nhận xét
                            </button>
                        </div>
                    </div>
                </div>
            `;
            elements.activitiesContainer.insertAdjacentHTML('beforeend', activityHtml);
            const newRow = elements.activitiesContainer.querySelector(`[data-id="${activityCounter}"]`);
            newRow.querySelector('.remove-activity-btn').addEventListener('click', () => newRow.remove());
        }
        
        // ĐÃ CẬP NHẬT HÀM NÀY ĐỂ GIỐNG PDF
        function populateEvaluationTable() {
            const table = elements.evaluationTableBody.parentElement;
            let thead = table.querySelector('thead');
            if (!thead) {
                thead = document.createElement('thead');
                table.prepend(thead);
            }
            // ĐÃ THAY ĐỔI CÁC CỘT
            thead.innerHTML = `
                <tr class="bg-gray-50">
                    <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider w-2/3">Nội dung (Tiêu chí)</th>
                    <th class="py-3 px-4 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider">Điểm tối đa</th>
                    <th class="py-3 px-4 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider">Điểm đạt</th>
                </tr>`;

            elements.evaluationTableBody.innerHTML = ''; // Clear existing body
            evaluationCriteria.forEach(category => {
                const totalPoints = category.items.reduce((sum, item) => sum + item.diem_max, 0);
                elements.evaluationTableBody.innerHTML += `
                    <tr class="bg-gray-100 font-bold">
                        <!-- ĐÃ THAY ĐỔI COLSPAN -->
                        <td colspan="3" class="py-2 px-4 text-gray-700">${category.category} (${totalPoints.toFixed(1)} điểm)</td>
                    </tr>
                `;
                category.items.forEach(item => {
                    // ĐÃ THAY ĐỔI CÁC CỘT
                    elements.evaluationTableBody.innerHTML += `
                        <tr>
                            <td class="py-2 px-4 border-b">${item.noidung}</td>
                            <td class="py-2 px-4 border-b text-center">${item.diem_max.toFixed(1)}</td>
                            <td class="py-2 px-4 border-b text-center">
                                <input type="number" class="score-input w-20 p-1 text-center border border-gray-300 rounded-md" min="0" max="${item.diem_max}" data-max="${item.diem_max}" value="0" step="0.25">
                            </td>
                        </tr>
                    `;
                });
            });
            
            document.querySelectorAll('.score-input').forEach(input => input.addEventListener('input', updateTotalScore));
        }
        
        function updateTotalScore() {
            let totalScore = 0;
            const maxScore = evaluationCriteria.flatMap(c => c.items).reduce((sum, item) => sum + item.diem_max, 0);
            
            document.querySelectorAll('.score-input').forEach(input => {
                let value = parseFloat(input.value) || 0;
                const max = parseFloat(input.dataset.max);
                if (value > max) value = max;
                if (value < 0) value = 0;
                totalScore += value;
            });
            
            elements.totalScoreEl.textContent = `${totalScore.toFixed(2)}/${maxScore.toFixed(2)}`;
            
            let ratingText = "Không đạt";
            let ratingClass = "text-red-600";

            // XẾP LOẠI THEO CV 5512 (Thang 20)
            if (totalScore >= 18) { 
                ratingText = "Giỏi"; 
                ratingClass = "text-green-600"; 
            } else if (totalScore >= 13.5) { 
                ratingText = "Khá"; 
                ratingClass = "text-blue-600"; 
            } else if (totalScore >= 10) { 
                ratingText = "Trung bình"; 
                ratingClass = "text-yellow-600"; 
            }
            
            elements.ratingEl.textContent = ratingText;
            elements.ratingEl.className = `py-3 px-4 text-center text-lg font-bold ${ratingClass}`;
        }
        
        async function handleAiSuggest(event) {
            const button = event.target.closest('.ai-suggest-btn');
            if (!button) return;

            const activityRow = button.closest('.activity-row');
            const activity = activityRow.querySelector('.teacher-student-activity').value;
            const content = activityRow.querySelector('.content').value;
            const reviewTextarea = activityRow.querySelector('.review');

            if (!activity) {
                reviewTextarea.value = "Vui lòng nhập 'Hoạt động của Thầy và Trò' trước.";
                return;
            }

            const originalButtonContent = button.innerHTML;
            button.innerHTML = '<div class="loader"></div><span class="ml-2">Đang xử lý...</span>';
            button.disabled = true;

            const prompt = `Với vai trò là một chuyên gia giáo dục, hãy nhận xét **cực kỳ ngắn gọn (tối đa 2-3 câu)** về hoạt động dạy học sau, tập trung vào ưu/nhược điểm chính:\n- **Hoạt động của Thầy và Trò:** ${activity}\n- **Nội dung chính:** ${content}\n\n**Nhận xét (ngắn gọn):**`;

            reviewTextarea.value = await callGeminiApi(prompt);
            button.innerHTML = originalButtonContent;
            button.disabled = false;
        }

        // ĐÃ XOÁ HÀM handleAiNoteSuggest VÀ handleAiOverallReview

        // ĐÃ THÊM HÀM MỚI ĐỂ XỬ LÝ NÚT GỢI Ý CỦA NGƯỜI DỰ GIỜ
        async function handleAiAttendeeReview() {
             const button = elements.aiAttendeeReviewBtn;
             const originalButtonContent = button.innerHTML;
             button.innerHTML = '<div class="loader"></div><span class="ml-2">Đang tổng hợp...</span>';
             button.disabled = true;
             
             let promptData = `Với vai trò là một chuyên gia giáo dục, dựa trên toàn bộ thông tin về tiết dạy dưới đây, hãy viết một nhận xét tổng thể cho "Người dự giờ" (người đánh giá).\n\n**THÔNG TIN TIẾT DẠY:**\n`;
             
             // 1. Thu thập dữ liệu từ "Phần ghi nhận"
             promptData += "\n**PHẦN GHI NHẬN HOẠT ĐỘNG:**\n";
             const activityRows = document.querySelectorAll('.activity-row');
             if (activityRows.length > 0 && Array.from(activityRows).some(r => r.querySelector('.teacher-student-activity').value)) {
                document.querySelectorAll('.activity-row').forEach(row => {
                    promptData += `- **${row.querySelector('.activity-title').value}:**\n  - Hoạt động Thầy/Trò: ${row.querySelector('.teacher-student-activity').value}\n  - Nội dung: ${row.querySelector('.content').value}\n  - Nhận xét (nếu có): ${row.querySelector('.review').value}\n`;
                });
             } else {
                 promptData += "(Không có thông tin chi tiết về hoạt động được ghi nhận.)\n";
             }
             

            // 2. Thu thập dữ liệu từ "Tiêu chí đánh giá"
            promptData += "\n**II. TIÊU CHÍ ĐÁNH GIÁ (Thang 20 điểm):**\n";
            document.querySelectorAll('#evaluation-table-body tr').forEach(row => {
                if (row.cells.length > 1) { // Bỏ qua hàng tiêu đề
                    const content = row.cells[0].textContent;
                    const score = row.cells[2].querySelector('input')?.value || '0';
                    const maxScore = row.cells[1].textContent;
                    promptData += `- ${content}: ${score}/${maxScore} điểm\n`;
                } else if (row.cells.length === 1) { // Hàng tên danh mục
                    promptData += `\n**${row.textContent}**\n`;
                }
            });
            promptData += `\n- **Tổng điểm:** ${elements.totalScoreEl.textContent}\n- **Xếp loại:** ${elements.ratingEl.textContent}\n\n`;
            
            // 3. Yêu cầu cuối cùng
            promptData += "Dựa trên toàn bộ thông tin trên, hãy viết nhận xét cho 'Người dự giờ' (người đánh giá) bao gồm 2 mục rõ ràng: 'a) Những thành công' và 'b) Những hạn chế'.";

            const result = await callGeminiApi(promptData);
            
            // 4. Phân tích kết quả và điền vào ô
            const successMatch = result.match(/(?:a\)\s*Những thành công|Những thành công):([\s\S]*?)(?:b\)\s*Những hạn chế|Những hạn chế)/i);
            const weaknessMatch = result.match(/(?:b\)\s*Những hạn chế|Những hạn chế):([\s\S]*)/i);

            elements.ndThanhCong.value = successMatch ? successMatch[1].trim() : "";
            elements.ndHanche.value = weaknessMatch ? weaknessMatch[1].trim() : "";
            
            if (!successMatch && !weaknessMatch) {
                // Nếu AI không trả về đúng định dạng
                elements.ndThanhCong.value = "AI không thể phân tích cú pháp. Dữ liệu thô:\n" + result;
                elements.ndHanche.value = "";
            }

            button.innerHTML = originalButtonContent;
            button.disabled = false;
        }

        // --- PowerPoint Analysis Functions ---
        async function handleExtractPpt() {
            const file = elements.pptUpload.files[0];
            if (!file) {
                elements.pptStatus.textContent = "Vui lòng chọn một tệp PowerPoint (.pptx) trước.";
                elements.pptStatus.classList.add('text-red-500');
                return;
            }

            const button = elements.extractPptBtn;
            const originalButtonContent = button.innerHTML;
            button.innerHTML = '<div class="loader"></div><span class="ml-2">Đang đọc...</span>';
            button.disabled = true;
            elements.pptStatus.textContent = "Bắt đầu đọc và trích xuất nội dung...";
            elements.pptStatus.classList.remove('text-red-500', 'text-green-600');

            try {
                const text = await extractTextFromPptx(file);
                pptTextContent = text;
                 if (!pptTextContent.trim()) {
                     elements.pptStatus.textContent = "Lỗi: Không tìm thấy nội dung văn bản trong tệp.";
                     elements.pptStatus.classList.add('text-red-500');
                     pptTextContent = null;
                 } else {
                    const slideCount = (pptTextContent.match(/--- Slide/g) || []).length;
                    elements.pptStatus.textContent = `Trích xuất thành công nội dung từ ${slideCount} slide.`;
                    elements.pptStatus.classList.add('text-green-600');
                 }
            } catch (error) {
                console.error("Error processing PPTX file:", error);
                elements.pptStatus.textContent = `Lỗi: ${error.message}`;
                elements.pptStatus.classList.add('text-red-500');
                pptTextContent = null;
            } finally {
                button.innerHTML = originalButtonContent;
                button.disabled = false;
            }
        }
        
        async function handleAiPptOverview() {
            if (!pptTextContent) {
                 elements.pptAnalysisResult.value = "Vui lòng tải lên và trích xuất nội dung từ tệp PowerPoint trước.";
                 return;
            }

            const button = elements.aiOverviewPptBtn;
            const originalButtonContent = button.innerHTML;
            button.innerHTML = '<div class="loader"></div><span class="ml-2">Đang phân tích...</span>';
            button.disabled = true;
            elements.pptAnalysisResult.value = "Đang gửi nội dung đến AI để nhận xét tổng quan...";

            const subject = document.getElementById('subject').value || '[Chưa nhập Môn học]';
            const className = document.getElementById('className').value || '[Chưa nhập Lớp]';

            const prompt = `Bạn là một chuyên gia về giáo dục và thẩm định chương trình giảng dạy tại Việt Nam.
            **Bối cảnh:** Tôi có một bài giảng được soạn thảo trên PowerPoint dành cho Môn học "${subject}", Lớp "${className}" thuộc cấp Trung học cơ sở (THCS) theo Chương trình Giáo dục Phổ thông (GDPT) 2018.
            **Nhiệm vụ:** Dựa vào nội dung văn bản được trích xuất từ các slide dưới đây, hãy phân tích và đưa ra nhận xét, góp ý chi tiết theo các tiêu chí sau:
            
            1.  **Tính phù hợp với Chương trình GDPT 2018:**
                * Nội dung bài giảng có bám sát yêu cầu cần đạt về phẩm chất và năng lực của môn học trong chương trình không?
                * Mục tiêu bài học có rõ ràng và phù hợp với mục tiêu chung của chương trình không?
            
            2.  **Phương pháp và Kỹ thuật dạy học:**
                * Bài giảng có thể hiện được tinh thần đổi mới của chương trình không (ví dụ: dạy học phát triển năng lực, lấy học sinh làm trung tâm)?
                * Các hoạt động được đề xuất (nếu có) có đa dạng, hấp dẫn và phù hợp để tổ chức cho học sinh hoạt động không? (ví dụ: thảo luận nhóm, dự án, giải quyết vấn đề).
            
            3.  **Cấu trúc và Nội dung:**
                * Cấu trúc bài giảng có logic, khoa học và dễ theo dõi không?
                * Nội dung kiến thức có chính xác, cập nhật và phù hợp với trình độ nhận thức của học sinh lớp ${className} không?
            
            4.  **Đánh giá:**
                * Bài giảng có gợi ý các hình thức đánh giá (câu hỏi, bài tập, hoạt động) phù hợp với mục tiêu phát triển năng lực không (đánh giá thường xuyên, đánh giá quá trình)?
            
            5.  **Góp ý & Đề xuất cải tiến:**
                * Đưa ra những góp ý cụ thể, mang tính xây dựng để giáo viên có thể cải thiện bài giảng này tốt hơn, bám sát hơn nữa tinh thần của chương trình GDPT 2018.
            
            **NỘI DUNG TRÍCH XUẤT TỪ POWERPOINT:**
            ---
            ${pptTextContent}
            ---
            
            Hãy trình bày kết quả phân tích một cách rõ ràng, có cấu trúc theo các mục trên.`;

            elements.pptAnalysisResult.value = await callGeminiApi(prompt);

            button.innerHTML = originalButtonContent;
            button.disabled = false;
        }

        async function handleAiFillFromPpt(event) {
            const button = event.target.closest('.ai-fill-from-ppt-btn');
            if (!button) return;

             if (!pptTextContent) {
                alert("Lỗi: Vui lòng tải lên và trích xuất nội dung từ tệp PowerPoint trước khi sử dụng tính năng này.");
                return;
            }

            const activityRow = button.closest('.activity-row');
            const activityTitle = activityRow.querySelector('.activity-title').value;
            const teacherStudentTextarea = activityRow.querySelector('.teacher-student-activity');
            const contentTextarea = activityRow.querySelector('.content');

            const originalButtonContent = button.innerHTML;
            button.innerHTML = '<div class="loader"></div><span class="ml-2">Đang điền...</span>';
            button.disabled = true;

            const prompt = `Dựa vào toàn bộ nội dung bài giảng PowerPoint đã được trích xuất dưới đây, hãy tập trung vào hoạt động có tên "${activityTitle}" và soạn thảo nội dung chi tiết cho hai mục sau:

            1.  **Hoạt động của Thầy và Trò:** Mô tả rõ ràng các bước, hành động của giáo viên (tổ chức, dẫn dắt, nêu câu hỏi) và của học sinh (lắng nghe, thảo luận, trình bày, làm bài tập).
            2.  **Nội dung:** Ghi lại những kiến thức, khái niệm, hoặc yêu cầu cốt lõi của hoạt động này mà học sinh cần nắm bắt.
            
            Hãy trình bày câu trả lời theo đúng hai mục trên.
            
            **TOÀN BỘ NỘI DUNG BÀI GIẢNG POWERPOINT:**
            ---
            ${pptTextContent}
            ---`;
            
            const result = await callGeminiApi(prompt);
            
            const teacherActivityMatch = result.match(/(?:1.\s*)?Hoạt động của Thầy và Trò:([\s\S]*?)(?:2.\s*Nội dung:|Nội dung:)/i);
            const contentMatch = result.match(/(?:2.\s*)?Nội dung:([\s\S]*)/i);

            teacherStudentTextarea.value = teacherActivityMatch ? teacherActivityMatch[1].trim() : "AI không thể tự động điền mục này. Vui lòng kiểm tra lại nội dung PPT.";
            contentTextarea.value = contentMatch ? contentMatch[1].trim() : "AI không thể tự động điền mục này.";

            button.innerHTML = originalButtonContent;
            button.disabled = false;
        }
        
        async function extractTextFromPptx(file) {
            const zip = await JSZip.loadAsync(file);
            const slidePromises = [];
            
            zip.folder("ppt/slides").forEach((relativePath, file) => {
                if (relativePath.startsWith("slide") && relativePath.endsWith(".xml")) {
                    slidePromises.push(file.async("string"));
                }
            });
            
            const slideXmls = await Promise.all(slidePromises);
            let fullText = "";
            
            const parser = new DOMParser();
            slideXmls.forEach((xmlString, index) => {
                const xmlDoc = parser.parseFromString(xmlString, "application/xml");
                const textNodes = xmlDoc.getElementsByTagName("a:t");
                let slideText = "";
                for (let i = 0; i < textNodes.length; i++) {
                    slideText += textNodes[i].textContent + " ";
                }
                if (slideText.trim()) {
                     fullText += `\n--- Slide ${index + 1} ---\n${slideText.trim()}\n`;
                }
            });
            
            return fullText;
        }

        // --- ĐÃ VIẾT LẠI HOÀN TOÀN HÀM exportToDocx ĐỂ GIỐNG HỆT FILE PDF ---
        function exportToDocx() {
            const { Document, Packer, Paragraph, Table, TableCell, TableRow, TextRun, AlignmentType, WidthType, BorderStyle, VerticalMerge } = docx;

            // --- Helper Functions ---
            const createBoldText = (text) => new TextRun({ text, bold: true, font: "Times New Roman", size: 24 });
            const createNormalText = (text) => new TextRun({ text, font: "Times New Roman", size: 24 });
            const createItalicText = (text) => new TextRun({ text, italics: true, font: "Times New Roman", size: 24 });
            const createMultiLine = (text) => (text || '').split('\n').map(line => new Paragraph({ children: [createNormalText(line)]}));
            const noBorders = { top: { style: BorderStyle.NONE, size: 0, color: "FFFFFF" }, bottom: { style: BorderStyle.NONE, size: 0, color: "FFFFFF" }, left: { style: BorderStyle.NONE, size: 0, color: "FFFFFF" }, right: { style: BorderStyle.NONE, size: 0, color: "FFFFFF" } };
            const fullBorders = { 
                top: { style: BorderStyle.SINGLE, size: 1, color: "000000" }, 
                bottom: { style: BorderStyle.SINGLE, size: 1, color: "000000" }, 
                left: { style: BorderStyle.SINGLE, size: 1, color: "000000" }, 
                right: { style: BorderStyle.SINGLE, size: 1, color: "000000" } 
            };

            // --- Gather Data from UI ---
            const data = {
                govBody: document.getElementById('governing-body').value.toUpperCase(),
                schoolUnit: document.getElementById('school-unit').value.toUpperCase(),
                teacherName: document.getElementById('teacherName').value,
                lessonName: document.getElementById('lessonName').value,
                subject: document.getElementById('subject').value,
                className: document.getElementById('className').value,
                period: document.getElementById('lesson-period').value,
                date: document.getElementById('lesson-date').value,
                attendeeName: document.getElementById('attendee-name').value,
                attendeeUnit: document.getElementById('attendee-unit').value,
            };

            // --- 1. Header Section (Giống PDF) ---
            const headerTable = new Table({
                width: { size: 100, type: WidthType.PERCENTAGE },
                rows: [ new TableRow({
                    children: [
                        new TableCell({ borders: noBorders, children: [
                            new Paragraph({ text: data.govBody, alignment: AlignmentType.CENTER }),
                            new Paragraph({ children: [createBoldText(data.schoolUnit)], alignment: AlignmentType.CENTER }),
                        ]}),
                        new TableCell({ borders: noBorders, children: [
                            new Paragraph({ children: [createBoldText("CỘNG HÒA XÃ HỘI CHỦ NGHĨA VIỆT NAM")], alignment: AlignmentType.CENTER }),
                            new Paragraph({ children: [createBoldText("Độc lập – Tự do – Hạnh phúc")], alignment: AlignmentType.CENTER }),
                        ]}),
                    ],
                })],
            });

            // --- 2. Title & General Info (I.) (Giống PDF) ---
            const formattedDate = data.date ? new Date(data.date).toLocaleDateString('vi-VN', { day: '2-digit', month: '2-digit', year: 'numeric' }) : '.../.../...';
            const generalInfo = [
                new Paragraph({ text: " " }),
                new Paragraph({ children: [createBoldText("PHIẾU ĐÁNH GIÁ BÀI DẠY")], alignment: AlignmentType.CENTER }),
                new Paragraph({ children: [createItalicText("(Theo Công văn số 5512/BGDĐT-GDTrH ngày 18/12/2020")], alignment: AlignmentType.CENTER }),
                new Paragraph({ children: [createItalicText("của Bộ Giáo dục và Đào tạo)")], alignment: AlignmentType.CENTER }),
                new Paragraph({ text: " " }),
                new Paragraph({ children: [createBoldText("I.")] }), // Mục I.
                new Paragraph({ children: [createNormalText("Tên bài dạy: "), createNormalText(data.lessonName), createNormalText(" ".repeat(20)), createNormalText("; Tiết PPCT: "), createNormalText(data.period || '...')]}),
                new Paragraph({ children: [
                    createNormalText("Môn học/Hoạt động giáo dục: "), createNormalText(data.subject),
                    createNormalText(" ".repeat(10)), createNormalText("Lớp: "), createNormalText(data.className),
                    createNormalText(" ".repeat(10)), createNormalText("Ngày: "), createNormalText(formattedDate),
                ]}),
                new Paragraph({ children: [createNormalText("Họ và tên giáo viên thực hiện: "), createNormalText(data.teacherName)] }),
                new Paragraph({ children: [createNormalText("Họ và tên giáo viên dự: "), createNormalText(data.attendeeName)] }),
                new Paragraph({ text: " " }),
            ];

            // --- 3. Activities Table (Phần ghi nhận) (Giống PDF) ---
            const activityTableRows = Array.from(document.querySelectorAll('.activity-row')).flatMap((row) => {
                const title = row.querySelector('.activity-title').value;
                const activity = row.querySelector('.teacher-student-activity').value;
                const content = row.querySelector('.content').value;
                const review = row.querySelector('.review').value;
                
                // Tách Hoạt động Thầy/Trò và gộp với title
                const teacherStudentContent = [new Paragraph({ children: [createBoldText(title)] }), ...createMultiLine(activity)];
                
                return [ new TableRow({ children: [
                    new TableCell({ children: teacherStudentContent, borders: fullBorders }),
                    new TableCell({ children: createMultiLine(content), borders: fullBorders }),
                    new TableCell({ children: createMultiLine(review), borders: fullBorders }),
                ]})];
            });
            const activitiesTable = new Table({
                width: { size: 100, type: WidthType.PERCENTAGE },
                columnWidths: [40, 30, 30],
                rows: [
                    new TableRow({ tableHeader: true, children: [
                        new TableCell({ children: [new Paragraph({ children: [createBoldText("Hoạt động GV và HS")] })], borders: fullBorders }),
                        new TableCell({ children: [new Paragraph({ children: [createBoldText("Nội dung")] })], borders: fullBorders }),
                        new TableCell({ children: [new Paragraph({ children: [createBoldText("Nhận xét")] })], borders: fullBorders }),
                    ]}),
                    ...activityTableRows,
                ]
            });

            // --- 4. Evaluation Table (II. Tiêu chí đánh giá) (Giống PDF) ---
            const evalTableRows = [];
            const allScoreInputs = Array.from(document.querySelectorAll('.score-input'));
            let scoreInputIndex = 0;

            // Header Row
            evalTableRows.push(new TableRow({ tableHeader: true, children: [
                new TableCell({ children: [new Paragraph({children: [createBoldText("Nội dung")], alignment: AlignmentType.CENTER})], borders: fullBorders }),
                new TableCell({ children: [new Paragraph({children: [createBoldText("STT")], alignment: AlignmentType.CENTER})], borders: fullBorders }),
                new TableCell({ children: [new Paragraph({children: [createBoldText("Tiêu chí")], alignment: AlignmentType.CENTER})], borders: fullBorders }),
                new TableCell({ children: [new Paragraph({children: [createBoldText("Điểm tối đa")], alignment: AlignmentType.CENTER})], borders: fullBorders }),
                new TableCell({ children: [new Paragraph({children: [createBoldText("Điểm đánh giá")], alignment: AlignmentType.CENTER})], borders: fullBorders }),
            ]}));

            // Data Rows with Merging
            evaluationCriteria.forEach(category => {
                const numItems = category.items.length;
                category.items.forEach((item, index) => {
                    const sttMatch = item.noidung.match(/^(\d+)\./); // Lấy số STT
                    const stt = sttMatch ? sttMatch[1] : '';
                    const tieuchi = sttMatch ? item.noidung.substring(sttMatch[0].length).trim() : item.noidung;
                    
                    const diemMax = item.diem_max.toFixed(2);
                    const diemDat = allScoreInputs[scoreInputIndex] ? allScoreInputs[scoreInputIndex].value : '0';
                    scoreInputIndex++;

                    const rowCells = [
                        new TableCell({ // STT
                            children: [new Paragraph({ text: stt, alignment: AlignmentType.CENTER })],
                            borders: fullBorders,
                        }),
                        new TableCell({ // Tiêu chí
                            children: [new Paragraph(tieuchi)],
                            borders: fullBorders,
                        }),
                        new TableCell({ // Điểm tối đa
                            children: [new Paragraph({ text: diemMax, alignment: AlignmentType.CENTER })],
                            borders: fullBorders,
                        }),
                        new TableCell({ // Điểm đánh giá
                            children: [new Paragraph({ text: diemDat, alignment: AlignmentType.CENTER })],
                            borders: fullBorders,
                        }),
                    ];

                    if (index === 0) {
                        // Hàng đầu tiên, bắt đầu gộp ô "Nội dung"
                        rowCells.unshift(new TableCell({
                            children: [new Paragraph({children: [createBoldText(category.category)]})],
                            verticalMerge: VerticalMerge.RESTART,
                            borders: fullBorders,
                        }));
                    } else {
                        // Các hàng tiếp theo, tiếp tục gộp
                        rowCells.unshift(new TableCell({
                            children: [new Paragraph("")], // Phải có 1 paragraph
                            verticalMerge: VerticalMerge.CONTINUE,
                            borders: fullBorders,
                        }));
                    }
                    evalTableRows.push(new TableRow({ children: rowCells }));
                });
            });
            
            // Total Row
            const totalScore = elements.totalScoreEl.textContent.split('/')[0];
            const maxScore = elements.totalScoreEl.textContent.split('/')[1];
            evalTableRows.push(new TableRow({ children: [
                new TableCell({ children: [new Paragraph({children: [createBoldText("Tổng cộng")], alignment: AlignmentType.CENTER })], columnSpan: 3, borders: fullBorders }),
                new TableCell({ children: [new Paragraph({children: [createBoldText(maxScore)], alignment: AlignmentType.CENTER })], borders: fullBorders }),
                new TableCell({ children: [new Paragraph({children: [createBoldText(totalScore)], alignment: AlignmentType.CENTER })], borders: fullBorders }),
            ]}));

            const evaluationTable = new Table({
                width: { size: 100, type: WidthType.PERCENTAGE },
                columnWidths: [20, 5, 50, 10, 15],
                rows: evalTableRows
            });

            // --- 5. Feedback Section (III. Nhận xét, đánh giá) (Giống PDF) ---
            const feedbackSection = [
                new Paragraph({ text: " " }),
                new Paragraph({ children: [createBoldText("III. Nhận xét, đánh giá")] }),
                new Paragraph({ children: [createBoldText("1. Giáo viên dạy tự nhận xét")] }),
                new Paragraph({ children: [createNormalText("a) Những thành công của giờ dạy (kế hoạch và tài liệu dạy học, tổ chức hoạt động học cho học sinh, hoạt động học của học sinh,...):")] }),
                ...createMultiLine(document.getElementById('gv-thanhcong').value),
                new Paragraph({ children: [createNormalText("b) Những hạn chế của tiết học cần lưu ý (kế hoạch và tài liệu dạy học, tổ chức hoạt động học cho học sinh, hoạt động học của học sinh,...):")] }),
                ...createMultiLine(document.getElementById('gv-hanche').value),
                new Paragraph({ text: " " }),
                new Paragraph({ children: [createBoldText("2. Người dự giờ nhận xét")] }),
                new Paragraph({ children: [createNormalText("a) Những thành công của giờ dạy (kế hoạch và tài liệu dạy học, tổ chức hoạt động học cho học sinh, hoạt động học của học sinh,...):")] }),
                ...createMultiLine(document.getElementById('nd-thanhcong').value),
                new Paragraph({ children: [createNormalText("b) Những hạn chế của tiết học cần lưu ý (kế hoạch và tài liệu dạy học, tổ chức hoạt động học cho học sinh, hoạt động học của học sinh,...):")] }),
                ...createMultiLine(document.getElementById('nd-hanche').value),
            ];

            // --- 6. Rating & Signature (Giống PDF) ---
            const ratingText = elements.ratingEl.textContent;
            const signDateText = `..., ngày ${formattedDate.split('/')[0]} tháng ${formattedDate.split('/')[1]} năm ${formattedDate.split('/')[2]}`;
            
            const signatureSection = [
                new Paragraph({ text: " " }),
                new Paragraph({ children: [createBoldText(`Xếp loại bài dạy: ${ratingText}`)] }),
                new Paragraph({ text: " " }), new Paragraph({ text: " " }),
                new Paragraph({ children: [createItalicText(signDateText)], alignment: AlignmentType.RIGHT }),
                new Paragraph({ children: [createBoldText("Người đánh giá")], alignment: AlignmentType.RIGHT }),
                new Paragraph({ children: [createItalicText("(Kí và ghi họ tên)")], alignment: AlignmentType.RIGHT }),
                new Paragraph({ text: " " }), new Paragraph({ text: " " }), new Paragraph({ text: " " }), new Paragraph({ text: " " }),
                new Paragraph({ children: [createBoldText(data.attendeeName)], alignment: AlignmentType.RIGHT }),
            ];

            // --- Assemble Document ---
            const doc = new Document({
                sections: [{
                    children: [
                        headerTable,
                        ...generalInfo,
                        new Paragraph({ children: [createBoldText("Phần ghi nhận")] }),
                        activitiesTable,
                        new Paragraph({ text: " " }),
                        new Paragraph({ children: [createBoldText("II. Tiêu chí đánh giá")] }),
                        evaluationTable,
                        ...feedbackSection,
                        ...signatureSection
                    ],
                }],
            });

            // --- Generate and Download DOCX ---
            Packer.toBlob(doc).then(blob => {
                const fileName = `Phieu-Danh-Gia-5512-${data.teacherName.replace(/\s/g, '_') || 'GiaoVien'}.docx`;
                saveAs(blob, fileName);
            });
        }
        
        // --- Event Listeners ---
        elements.addActivityBtn.addEventListener('click', addActivityRow);
        elements.activitiesContainer.addEventListener('click', (event) => {
            if (event.target.closest('.ai-suggest-btn')) {
                handleAiSuggest(event);
            }
            if (event.target.closest('.ai-fill-from-ppt-btn')) {
                handleAiFillFromPpt(event);
            }
        });
        
        // ĐÃ XOÁ EVENT LISTENER CỦA CÁC NÚT AI CŨ
        elements.exportDocxBtn.addEventListener('click', exportToDocx);
        elements.extractPptBtn.addEventListener('click', handleExtractPpt);
        elements.aiOverviewPptBtn.addEventListener('click', handleAiPptOverview);
        
        // ĐÃ THÊM EVENT LISTENER CHO NÚT MỚI
        elements.aiAttendeeReviewBtn.addEventListener('click', handleAiAttendeeReview);

        // --- Initial setup ---
        addActivityRow();
        populateEvaluationTable();
        updateTotalScore();
        document.getElementById('lesson-date').valueAsDate = new Date(); // Set default date to today

    </script>

</body>

</html>


